name: Develop Branch Preview Publish

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  test-publish:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine wheel
    
    - name: Generate development version
      run: |
        # Create a unique dev version with timestamp (no local identifier)
        # Format: 1.0.0.devYYYYMMDDHHMMSS (PEP 440 compliant)
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        DEV_VERSION="1.0.0.dev${TIMESTAMP}"
        echo "DEV_VERSION=$DEV_VERSION" >> $GITHUB_ENV
        
        # Update version in __init__.py
        sed -i "s/__version__ = \".*\"/__version__ = \"$DEV_VERSION\"/" src/ai_threat_monitor/__init__.py
        
        # Use a test-specific package name to avoid conflicts
        sed -i "s/name=\"securevector-ai-monitor\"/name=\"securevector-ai-monitor-dev\"/" setup.py
        
        # Add development warning to package description
        sed -i 's/description="Real-time AI threat monitoring\./description="[DEVELOPMENT BUILD] Real-time AI threat monitoring./' setup.py
        
        # Update default API URL to use a test endpoint (prevent accidental production calls)
        sed -i 's|api_url: str = "https://api.securevector.io"|api_url: str = "https://api-test.securevector.io"|' src/ai_threat_monitor/models/config_models.py
        
        echo "Using development version: $DEV_VERSION"
        echo "Using test package name: securevector-ai-monitor-dev"
        echo "Git commit: $(git rev-parse --short HEAD)"
        echo "‚ö†Ô∏è  Development build with test API endpoint"
    
    - name: Security scan before build
      run: |
        echo "üîç Scanning for potential secrets before publishing..."
        
        # Check for common secret patterns (excluding test files and documentation)
        if grep -r -i --exclude-dir=.git --exclude-dir=tests --exclude="*.md" \
           -E "(password|secret|private.*key)\s*[:=]\s*['\"][^'\"]{10,}" src/; then
          echo "‚ùå Potential secrets found in source code!"
          exit 1
        fi
        
        # Check for hardcoded production URLs (already handled above, but double-check)
        if grep -r "api\.securevector\.io" src/ | grep -v "api-test\.securevector\.io"; then
          echo "‚ùå Production API URLs still present!"
          exit 1
        fi
        
        echo "‚úÖ Security scan passed"
    
    - name: Build package
      run: python -m build
    
    - name: Check package
      run: twine check dist/*
    
    - name: Publish to Test PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        TWINE_REPOSITORY_URL: https://test.pypi.org/legacy/
      run: |
        echo "Attempting to publish to Test PyPI..."
        echo "Package version: $DEV_VERSION"
        echo "Repository URL: $TWINE_REPOSITORY_URL"
        
        # Check if token is available
        if [ -z "$TWINE_PASSWORD" ]; then
          echo "‚ùå ERROR: TEST_PYPI_API_TOKEN secret is not set"
          exit 1
        fi
        
        # Upload with verbose output for debugging
        python -m twine upload --verbose dist/* || {
          echo "‚ùå Upload failed. Common causes:"
          echo "1. Package name 'securevector-ai-monitor' might already be taken"
          echo "2. Version $DEV_VERSION might already exist"
          echo "3. API token might be invalid or expired"
          echo "4. Token might not have upload permissions"
          exit 1
        }
    
    - name: Test install from Test PyPI
      run: |
        echo "Testing installation of development package..."
        pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ securevector-ai-monitor-dev
        python -c "import ai_threat_monitor; print('‚úÖ Package installed successfully')"
      continue-on-error: true

