name: Release

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: release
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine wheel
    
    - name: Fix package structure
      run: |
        echo "üîß Fixing package structure for production release..."
        
        # Move top-level modules into ai_threat_monitor package (if they don't already exist there)
        if [ -d "src/utils" ] && [ ! -d "src/ai_threat_monitor/utils" ]; then
          mv src/utils src/ai_threat_monitor/utils
          echo "Moved utils into ai_threat_monitor package"
        elif [ -d "src/utils" ] && [ -d "src/ai_threat_monitor/utils" ]; then
          echo "Merging src/utils into existing src/ai_threat_monitor/utils"
          cp -r src/utils/* src/ai_threat_monitor/utils/
          rm -rf src/utils
        fi
        
        if [ -d "src/core" ] && [ ! -d "src/ai_threat_monitor/core" ]; then
          mv src/core src/ai_threat_monitor/core  
          echo "Moved core into ai_threat_monitor package"
        elif [ -d "src/core" ] && [ -d "src/ai_threat_monitor/core" ]; then
          echo "Merging src/core into existing src/ai_threat_monitor/core"
          cp -r src/core/* src/ai_threat_monitor/core/
          rm -rf src/core
        fi
        
        if [ -d "src/config" ] && [ ! -d "src/ai_threat_monitor/config" ]; then
          mv src/config src/ai_threat_monitor/config
          echo "Moved config into ai_threat_monitor package"
        elif [ -d "src/config" ] && [ -d "src/ai_threat_monitor/config" ]; then
          echo "Merging src/config into existing src/ai_threat_monitor/config"
          cp -r src/config/* src/ai_threat_monitor/config/
          rm -rf src/config
        fi
        
        if [ -d "src/engines" ] && [ ! -d "src/ai_threat_monitor/engines" ]; then
          mv src/engines src/ai_threat_monitor/engines
          echo "Moved engines into ai_threat_monitor package"
        elif [ -d "src/engines" ] && [ -d "src/ai_threat_monitor/engines" ]; then
          echo "Merging src/engines into existing src/ai_threat_monitor/engines"
          cp -r src/engines/* src/ai_threat_monitor/engines/
          rm -rf src/engines
        fi
        
        if [ -d "src/integrations" ] && [ ! -d "src/ai_threat_monitor/integrations" ]; then
          mv src/integrations src/ai_threat_monitor/integrations
          echo "Moved integrations into ai_threat_monitor package"
        elif [ -d "src/integrations" ] && [ -d "src/ai_threat_monitor/integrations" ]; then
          echo "Merging src/integrations into existing src/ai_threat_monitor/integrations"
          cp -r src/integrations/* src/ai_threat_monitor/integrations/
          rm -rf src/integrations
        fi
        
        # Fix import statements to use proper package paths
        echo "üîß Fixing import statements..."
        
        # Fix all imports to use proper ai_threat_monitor package paths
        find src/ai_threat_monitor -name "*.py" -type f -exec sed -i 's|from utils\.|from ai_threat_monitor.utils.|g' {} \;
        find src/ai_threat_monitor -name "*.py" -type f -exec sed -i 's|from core\.|from ai_threat_monitor.core.|g' {} \;
        find src/ai_threat_monitor -name "*.py" -type f -exec sed -i 's|from config\.|from ai_threat_monitor.config.|g' {} \;
        find src/ai_threat_monitor -name "*.py" -type f -exec sed -i 's|from engines\.|from ai_threat_monitor.engines.|g' {} \;
        find src/ai_threat_monitor -name "*.py" -type f -exec sed -i 's|from integrations\.|from ai_threat_monitor.integrations.|g' {} \;
        
        # Fix imports without dots (direct module imports)
        find src/ai_threat_monitor -name "*.py" -type f -exec sed -i 's|from utils import|from ai_threat_monitor.utils import|g' {} \;
        find src/ai_threat_monitor -name "*.py" -type f -exec sed -i 's|from core import|from ai_threat_monitor.core import|g' {} \;
        find src/ai_threat_monitor -name "*.py" -type f -exec sed -i 's|from config import|from ai_threat_monitor.config import|g' {} \;
        
        # Fix specific problematic imports
        find src/ai_threat_monitor -name "*.py" -type f -exec sed -i 's|from utils\.exceptions|from ai_threat_monitor.utils.exceptions|g' {} \;
        find src/ai_threat_monitor -name "*.py" -type f -exec sed -i 's|from utils\.logger|from ai_threat_monitor.utils.logger|g' {} \;
        find src/ai_threat_monitor -name "*.py" -type f -exec sed -i 's|from utils\.security|from ai_threat_monitor.utils.security|g' {} \;
        find src/ai_threat_monitor -name "*.py" -type f -exec sed -i 's|from utils\.auto_config|from ai_threat_monitor.utils.auto_config|g' {} \;
        
        # Fix __init__.py imports specifically (need relative imports for package root)
        sed -i 's|from utils\.auto_config import|from .utils.auto_config import|g' src/ai_threat_monitor/__init__.py
        
        # Fix auto_config.py imports (now that it's inside ai_threat_monitor, use relative imports)
        if [ -f "src/ai_threat_monitor/utils/auto_config.py" ]; then
          sed -i 's|from ai_threat_monitor\.models\.config_models|from ..models.config_models|g' src/ai_threat_monitor/utils/auto_config.py
          echo "Fixed auto_config.py imports to use relative paths"
        fi
        
        echo "‚úÖ Package structure fixed for production release"
    
    - name: Security scan before production release
      run: |
        echo "üîç Production security scan..."
        
        # Check for common secret patterns (excluding test files and documentation)
        if grep -r -i --exclude-dir=.git --exclude-dir=tests --exclude="*.md" \
           -E "(password|secret|private.*key)\s*[:=]\s*['\"][^'\"]{10,}" src/; then
          echo "‚ùå Potential secrets found in source code!"
          exit 1
        fi
        
        # Ensure we're using production API endpoints (not dev)
        if grep -r "dev-api\.securevector\.io\|api-test\.securevector\.io" src/; then
          echo "‚ùå Development/test API URLs found in production release!"
          echo "Production releases should use api.securevector.io"
          exit 1
        fi
        
        echo "‚úÖ Production security scan passed"
    
    - name: Build package
      run: python -m build
    
    - name: Check package
      run: twine check dist/*
    
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}
        skip-existing: true
    
    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/*
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

